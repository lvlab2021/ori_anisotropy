
clear all;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%  cardinal(2p) radial(1p) combined model fitting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%  cardinal(2p) radial(1p) combined model fitting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%  cardinal(2p) radial(1p) combined model fitting

modej = 1;

for inNN = 1:4    %%%% need to modified
    
    %%%%%%%%%%%%%%%%%%%%%%% maybe need to modify %%%%%%%%%%%%%%%%%%
    inN = inNN;  %%%% 1 for LV1 (V1 left hemisphere); 2 RV1; 3 for LV4; 4 RV4;
    %%%%%%%%%%%%%%
    
    
    %%%%%%%%%%%%%%%%%%%%%%% data read  dots %%%%%%%%%%%%%%%%%%%%%%%
    nameindex = [{'LV1'},{'RV1'},{'LV4'},{'RV4'}];
    tempname = nameindex{inN};
    Resultfolder = [pwd,'\Fitting_Results\'];
    if ~exist(Resultfolder)
        mkdir(Resultfolder);
    end
    for dataread = 1  
        %%%%%%%%%% radial orientation  %%% generate in step01
        RaOri=[];  %%%%
        if inN == 1
            RaOri = [121.796330371969,109.606450089087,110.468132911126,119.030351239838,118.592602682600,122.918917215971,128.118456265052,115.226370716462,134.944174973321,130.284628099546,113.079516042469,126.863490894721,119.449754993943,118.751455540980,122.125190280634,129.401780694249,119.218714899910,123.989967002067,115.474858778181,125.675621428065,146.203716731979,128.792592818963,106.558115247290,124.217256634565,109.557243378465,121.804730864251-5];
        elseif inN == 2
            RaOri = [60.7805039738264,62.1657108204518,70.0798614481037,51.5440360831934,51.3943079867949,67.3283439614036,64.8629286212368,67.8247353208828,51.0332097778726,54.6029049132986,61.1114030323451,52.3247586676223,49.3097981267163,57.0136947557376,51.5031340422491,55.6686041829385,49.9237092027872,60.4289895433539,75.2551550445333,66.9176123945516,69.4370480444419,67.5729552640325];
        elseif inN ==3 
            RaOri = [133.396571438581,139.923982584023,133.251068853996,130.168662809262,127.206351861087,139.244709025595,133.938749694490,132.006576831034,132.099753919118,129.890102655013,137.617373265116,135.110323395035,129.890102655013,130.547218157796,135.852631840676,138.738999145747,136.360307900705,127.254820711932,135.179486867115,142.891287492460,128.542924728708,136.635785701017,136.851412388174];
        elseif inN==4
            RaOri = [43.9094649951697,46.5419388338852,48.9226497426267,47.3698394161760,45.1922118348316,40.7407583578652,45.0109089625959,45.9733877223262,43.5685517709776,45.7300705311051,50.6963086233522,41.7644694828548,41.0718107843144,40.1657385874589,47.8888037784861];
        end
        %%%%%%%%%% 18 bins pixel percentage curve  %%% shuffled curve
        OrdCurve=[];  
        if inN == 1
            OrdCurve = [5.46921661120659,5.58967657628226,5.39469780267728,5.55774969282078,5.50663645192619,5.55424561668254,5.43080761475102,5.42276767981153,5.41124658483872,5.49817668509587,5.55758792181212,5.61621230616212,5.68694013328943,5.55939567492841,5.50083588001661,5.63794267885510,5.62720440828053,5.66936539090612,5.50436910171269,5.49051117232935,5.66226648749769,5.47518618598827,5.70353608331743,5.55424561668254,5.55758792181212,5.63794267885510;5.48993795785034,5.65828160731787,5.35281079288619,5.73876601720204,5.44404877522391,5.59763079215672,5.58973307358420,5.43920445984632,5.49008413869972,5.51229267145042,5.51606173559684,5.48510330485103,5.56886431498995,5.49644514663770,5.46143771362857,5.51999010720367,5.57467382797843,5.64687602224403,5.42467668647326,5.52877257422712,5.48309751534793,5.33183945165755,5.61765587938602,5.59763079215672,5.51606173559684,5.51999010720367;5.72274838190661,5.41326363933355,5.36153725325933,5.62028260487976,5.64799827344340,5.61177813198525,5.46413069482894,5.67068911200296,5.48872487052971,5.41818609575344,5.44685142523803,5.54161580541616,5.65401514549439,5.50014811889009,5.55301183009807,5.51333149428786,5.61326772371059,5.62949787373242,5.26948619363859,5.34703091521273,5.56741232577135,5.43893758650234,5.56176558793860,5.61177813198525,5.44685142523803,5.51333149428786;5.65205202276910,5.39202874877491,5.36502783740859,5.52812883974022,5.44944426459480,5.52123515708263,5.50001708875902,5.62137877189859,5.65727412361185,5.42524408893071,5.37269752128217,5.67611555676116,5.40423937601472,5.53717784141404,5.49657661878547,5.61416191844150,5.35919124347388,5.62949787373242,5.48339741349179,5.46181512090603,5.63064843358891,5.38456468727345,5.61083999018512,5.52123515708263,5.37269752128217,5.61416191844150;5.48384344413159,5.61581182620059,5.55875525769238,5.57530279094260,5.50232006042948,5.43635111811143,5.51368809597047,5.51316997000288,5.71300411858256,5.70285848723680,5.36182161536864,5.67159455671595,5.46441262957118,5.54458378591883,5.52532663209566,5.64745498302054,5.46103624610041,5.51909551848217,5.43306536176162,5.45990205081114,5.42249624535610,5.69103011929085,5.63810354698874,5.43635111811143,5.36182161536864,5.64745498302054;5.50822149900659,5.48186867036916,5.66696336631935,5.47546954537476,5.52498111578720,5.62969809576806,5.56153662121057,5.64740367362034,5.52542511112017,5.48406069874133,5.60306898290505,5.61621230616212,5.54388673804199,5.53224054507751,5.59453962710168,5.64935744385362,5.53393582692782,5.60700850507033,5.56588605382733,5.55555555555556,5.42776592100756,5.90357872536743,5.68036206003435,5.62969809576806,5.60306898290505,5.64935744385362;5.50334588803159,5.64521398235871,5.49767003508037,5.69268913463226,5.41707132836948,5.63630018768804,5.56837212481630,5.55974084676812,5.50095828405986,5.40877543818374,5.66140338735033,5.55856955558570,5.56545828176978,5.52360027648859,5.59028036587054,5.57135654969703,5.51999914235787,5.52625122669284,5.51415588954911,5.62251300887665,5.50681105577952,5.43564225927635,5.45271136072412,5.63630018768804,5.66140338735033,5.57135654969703;5.58988798283785,5.70728520091473,5.72630329685673,5.49741091802703,5.51311103917125,5.63630018768804,5.58460644587990,5.49673318996809,5.55261047452052,5.78990706975650,5.55363304693448,5.49527555495276,5.49052555092588,5.64703268490175,5.50083588001661,5.51142903345477,5.48890961524030,5.46900556100752,5.57846906675988,5.55938169574533,5.50417621795379,5.34666842417452,5.41045284767851,5.63630018768804,5.55363304693448,5.51142903345477;5.47531112492534,5.52597190460634,5.66696336631935,5.33065648586976,5.66526383943024,5.58254029633961,5.55640999350627,5.49947265330722,5.64639997825171,5.74755911069286,5.75038807209737,5.63542655635427,5.70737633261050,5.48657055396465,5.54449330763579,5.37730554472210,5.45889214078196,5.56202976774616,5.53372946522195,5.59190388735843,5.57531683924854,5.62841890199697,5.52223343057335,5.58254029633961,5.75038807209737,5.37730554472210;5.38755012737534,5.63541326363933,5.75248267797616,5.65538880112340,5.67821301392036,5.45898686183708,5.68713899996582,5.87203966742915,5.53629925648031,5.58757793200800,5.64855004399798,5.63768705637687,5.56772897058323,5.42485434975807,5.78620638250296,5.65506482635289,5.66794240933115,5.66016519463526,5.69451240824886,5.76025405570860,5.69915421705794,5.67290581954788,5.55494969873770,5.45898686183708,5.64855004399798,5.65506482635289;5.67277336941286,5.63377981051944,5.66696336631935,5.49411971212919,5.63612819682745,5.40522697048865,5.60596739464780,5.55015272508116,5.64096290557164,5.63463121985649,5.55066689077624,5.42633030426330,5.44170574143667,5.69023402784635,5.66801188333884,5.47718473845920,5.59289872318528,5.38518155053974,5.69451240824886,5.51729415365779,5.55950781229415,5.45870954985830,5.46770631696611,5.40522697048865,5.55066689077624,5.47718473845920;5.70690264623786,5.58640967004247,5.69488803951341,5.65868000702124,5.53900938815151,5.54009827685401,5.60511295669709,5.59398413850727,5.60426266498117,5.65345253499588,5.61394488881858,5.57100230571002,5.48484882889225,5.50014811889009,5.77981749065625,5.59799100136026,5.62827646093976,5.50989532221132,5.74204823488291,5.75068870523416,5.59903037968013,5.50484413102221,5.54813380953679,5.54009827685401,5.61394488881858,5.59799100136026;5.53991297034410,5.52923881084613,5.57271759428940,5.55774969282078,5.66634293730441,5.69571901496789,5.48976383335042,5.57754735847248,5.55668827903057,5.54758263733678,5.65645979375328,5.62412405624124,5.59611258075137,5.52236595240446,5.52852107801902,5.59799100136026,5.43852314025665,5.57225220804710,5.58406151695212,5.53833792470156,5.70705873053514,5.74210769129375,5.51269118569208,5.69571901496789,5.65645979375328,5.59799100136026;5.57526114991285,5.35282587389742,5.52210412412517,5.57091451641215,5.62965360958239,5.51086044120837,5.57264431456988,5.39948224142890,5.44794682542919,5.67462651452770,5.53979098486272,5.54274605542746,5.57113500380341,5.57050459168559,5.55620627602142,5.53901471553454,5.65078956678352,5.59065260058881,5.59105207969242,5.51729415365779,5.48309751534793,5.79153759968365,5.62310859074675,5.51086044120837,5.53979098486272,5.53901471553454;5.43508733438159,5.56517477948383,5.59191580711032,5.50618746708794,5.69116218841049,5.55518877267111,5.64698041628217,5.42824660648979,5.66814826897199,5.45818139042466,5.62383207601270,5.53935530539355,5.65515048990111,5.44213488693591,5.62222482510409,5.54091717636763,5.41601003441289,5.46389434085705,5.55749737853897,5.49242424242424,5.55950781229415,5.67455348316088,5.52087025273317,5.55518877267111,5.62383207601270,5.54091717636763;5.53625626211285,5.51290427964717,5.60936872785661,5.56542917324908,5.57138232437682,5.54198458883115,5.52052359957620,5.58028682181161,5.52542511112017,5.68403717209740,5.52792636022978,5.47945205479452,5.59384189193792,5.67418781475264,5.55727109132921,5.37445185347247,5.68616730453800,5.49353941772980,5.85249912617966,5.59764309764310,5.52788975838537,5.56580768470309,5.58085007770114,5.54198458883115,5.52792636022978,5.37445185347247;5.61060932948160,5.61907873244038,5.56399113391626,5.46449885904862,5.48181720082012,5.52783724900261,5.58631532178133,5.36523894968976,5.49280267503976,5.23232560875191,5.50914070456096,5.43198155431982,5.46554797397791,5.64826700898588,5.44227103808844,5.53520979386837,5.62184414498440,5.46389434085705,5.59944075498078,5.77173247627793,5.53315943403684,5.47353852237527,5.47179585048665,5.52783724900261,5.50914070456096,5.53520979386837;5.64108189807535,5.53577262332571,5.43483952039374,5.51057574161840,5.43541599223050,5.55801824063682,5.51625140982262,5.76246113386388,5.54173632916038,5.54052464415951,5.50617454840273,5.45119580451196,5.53821001600836,5.70010862051940,5.29213207969078,5.63984513968819,5.66043804071656,5.60189728491986,5.37714085983922,5.43694520967248,5.55160329881696,5.48012917682726,5.52223343057335,5.55801824063682,5.50617454840273,5.63984513968819];
        elseif inN == 2
            OrdCurve =  [5.61848973172566,5.59644232877141,5.64464400256575,5.54848653201670,5.44081174811933,5.52686458957996,5.72399955411883,5.38154940977047,5.50896522685007,5.70532427808595,5.59348232111805,5.55548414463283,5.52274781560711,5.31294022942242,5.50569075599149,5.47076451320650,5.52794888822735,5.80780084660351,5.75113920329266,5.38154940977047,5.55548414463283,5.31294022942242;5.60025528229207,5.41323478751057,5.65027064132429,5.48486532016703,5.42125899169523,5.54745048197839,5.49130531713298,5.58007421773590,5.44229622092003,5.65866556068225,5.51619759129259,5.52077843618648,5.48056643567340,5.63270052100803,5.43397797723698,5.71003786558878,5.25773431954018,5.42229389236041,5.62251947670146,5.58007421773590,5.52077843618648,5.63270052100803;5.63444487498006,5.67943377908615,5.69865973464772,5.68289754296672,5.49535364761817,5.55819094757758,5.47597815182254,5.49455583892002,5.70809502087793,5.26897886532912,5.39060990532621,5.49892669383138,5.57999397408858,5.61481183336688,5.45942444711761,5.44288800613283,5.25773431954018,5.61378754283411,5.40080356705375,5.49455583892002,5.49892669383138,5.61481183336688;5.52047956602010,5.65281387992860,5.55574311018084,5.56730407354971,5.59826289195559,5.60920815917370,5.63900345557909,5.61061649588443,5.52826414961929,5.44351703043185,5.60314291234624,5.50021209044050,5.42332027719192,5.67965832606606,5.61904321273249,5.62176225985551,5.51878907233965,5.57347309010280,5.54534764074673,5.61061649588443,5.50021209044050,5.67965832606606;5.57860187358968,5.58234944098212,5.63901736380721,5.51443574257603,5.48197544585430,5.49732830918220,5.57212127967896,5.63046897668097,5.59054703673813,5.77617640451380,5.72551040123656,5.48221653791277,5.71256402530883,5.51642405134053,5.68612936059961,5.58691662601343,5.69053562023403,5.58355170328563,5.66049291979029,5.63046897668097,5.48221653791277,5.51642405134053;5.50908303512411,5.44768406877329,5.43983435175495,5.54490223839137,5.53343006802301,5.58056691757588,5.47597815182254,5.59534535681016,5.55107196743746,5.49190384848014,5.73195079538868,5.59147524968829,5.89635432359144,5.48288276201337,5.57971685018969,5.51257927381699,5.44093063729419,5.70449506147954,5.66661766867558,5.59534535681016,5.59147524968829,5.48288276201337;5.55694846488729,5.61993047508691,5.40044788044518,5.42124410831735,5.45624813476995,5.60920815917370,5.48991193846840,5.64726722966266,5.65984771395488,5.34415124336841,5.51297739421653,5.38709718883762,5.96565230491112,5.43592495695535,5.49875080966041,5.29653634399610,5.49817948659232,5.67173956863536,5.43755206036552,5.64726722966266,5.38709718883762,5.43592495695535;5.49084858569052,5.51814850771977,5.47697016756130,5.47411243929103,5.50873184938203,5.58325203397567,5.61113588228737,5.62283340714384,5.52300080704586,5.42623602398604,5.55806015328138,5.56962350733319,5.91744501355830,5.41580018335905,5.41084482280004,5.34299718911887,5.27834390528750,5.56843378351139,5.29300798667255,5.62283340714384,5.56962350733319,5.41580018335905;5.58999840448568,5.42106416961573,5.48147147856813,5.68737790999839,5.49947001739166,5.71303265996581,5.47876490915171,5.80455996212757,5.61949542089196,5.66039366132683,5.45501384684743,5.42565908711133,5.71557698101838,5.50747970751996,5.54270380309059,5.43359583710828,5.59893746135703,5.61378754283411,5.69479151354794,5.80455996212757,5.42565908711133,5.50747970751996;5.57176395505208,5.58548119382418,5.47246885655447,5.53504543092170,5.48917909295792,5.47137218398418,5.49966558912050,5.67475527999633,5.52738692585705,5.66212176197142,5.49204611322213,5.62361016491638,5.37511298583911,5.62152009123231,5.54039048764690,5.61247009083095,5.63099681696398,5.42733319895182,5.68376696555441,5.67475527999633,5.62361016491638,5.62152009123231;5.52275887219930,5.59487645235038,5.69078244038576,5.50816322873170,5.59414652218209,5.51701916278071,5.37983502396611,5.55564039521708,5.68090108424857,5.48844764719097,5.37772911702196,5.59147524968829,5.55890328412172,5.78475436595783,5.58665679652077,5.38481194972937,5.65389635668323,5.43993146543036,5.52207359498261,5.55564039521708,5.59147524968829,5.78475436595783;5.56834499578329,5.59957408161348,5.62888941404184,5.47948887972903,5.82157595216778,5.57072149077662,5.79227510868354,5.52967945879083,5.48528018526966,5.45474968462163,5.59670251819411,5.57347969716056,5.14914130762278,5.70872744348293,5.72545572314241,5.61711617534323,5.61496713916050,5.46260834509172,5.45715125679847,5.52967945879083,5.57347969716056,5.70872744348293;5.55352950561849,5.64028686856033,5.52198327762961,5.60045878958404,5.60135016928571,5.52059931798044,5.41884962657452,5.43499839653040,5.67125162286396,5.50227245234762,5.48882591614607,5.59147524968829,5.54685146128352,5.46275798841708,5.67456278338114,5.71236090784491,5.71114520598136,5.30890949405362,5.52207359498261,5.43499839653040,5.59147524968829,5.46275798841708;5.50338476967611,5.56355892392972,5.60863351451110,5.57805695442571,5.72587035493399,5.59578257717472,5.44532382120165,5.57549287601362,5.50019298922769,5.76494375032402,5.58060153281381,5.50535367687700,5.51973485989756,5.47170233223765,5.46636439344869,5.75185262619927,5.70885525200943,5.60874823624269,5.76461365084032,5.57549287601362,5.50535367687700,5.47170233223765;5.59683632302327,5.40383952898437,5.50172737809887,5.46963207225936,5.66309571588816,5.56177110277731,5.51638613309553,5.45026953560466,5.57037089020668,5.66039366132683,5.72873059831262,5.52077843618648,5.42934618861103,5.56561794235371,5.53576385675951,5.63802355564848,5.62183700107628,5.31646845394074,5.77808809838797,5.45026953560466,5.52077843618648,5.56561794235371;5.55352950561849,5.68099965550719,5.49610073934033,5.56640800014337,5.58488469019172,5.51343900758098,5.57630141567272,5.49455583892002,5.56598477139549,5.56621217619714,5.51136729567850,5.67116983945396,5.34498342874360,5.69307484179692,5.55889701119645,5.62408530211165,5.72259497584099,5.50796210441443,5.19991180361605,5.49455583892002,5.67116983945396,5.69307484179692;5.49768650422811,5.50718737277254,5.43758369625153,5.74114231437839,5.58591378263510,5.54029017157894,5.68498495151042,5.52967945879083,5.44229622092003,5.48585549622410,5.58382172988987,5.77400156818386,5.46851461283519,5.54772925471255,5.57277690385861,5.55904011893976,5.74778446953216,5.63646442249546,5.33098142976138,5.52967945879083,5.77400156818386,5.54772925471255;5.53301575000570,5.49309448498324,5.65477195233112,5.59597842255238,5.49844092494829,5.48390272718322,5.72817969011258,5.38765786540018,5.42475174567529,5.63965645359186,5.55322985766729,5.61718318187077,5.39319072009641,5.54549316875741,5.60285000462663,5.68216135851511,5.51878907233965,5.73221124773231,5.66906756822970,5.38765786540018,5.61718318187077,5.54549316875741] ;
        elseif inN ==3 
            OrdCurve =  [5.62817351752401,5.56179201959384,5.69687702715226,5.52538168755079,5.55774969282078,5.43516275695911,6.02107045433167,5.71682464454976,5.61914434719100,5.80132068748531,5.68694013328943,5.71933666141005,5.59283098687652,5.46043792439813,5.57363202702832,5.81318903610802,5.70441136928017,5.53163747293840,5.72382816998733,5.69829533785171,5.48818515695378,5.70881226053640,5.69409808811305;5.40975670168091,5.60261251148076,5.62969140950792,5.49972202027114,5.73876601720204,5.50251939741713,5.57332329978365,5.77060987777501,5.66365016147622,5.63907779319338,5.56886431498995,5.49534437558384,5.61860789531543,5.61204110534152,5.61586378338948,5.62354607059776,5.52567894595321,5.64972446368825,5.73102614303812,5.47648387759293,5.30801746240732,5.50839964633068,5.60681629260183;5.44578421769626,5.36075109705072,5.55439718283755,5.58953085574991,5.62028260487976,5.62427947824510,5.28172326215784,5.44789847842355,5.66365016147622,5.49957922987695,5.65401514549439,5.42201954659140,5.44044396934064,5.57482116271470,5.57267221438375,5.53757459289977,5.49878999731111,5.75305058059437,5.48629505931130,5.50010269049086,5.31956667359619,5.34630120837017,5.41770573566085;5.38836536404679,5.61792019593836,5.56250579186359,5.52538168755079,5.52812883974022,5.55044623774304,5.30429874894178,5.62484410077326,5.49475630213742,5.51170953973056,5.40423937601472,5.62190503932421,5.50791881790131,5.44954428265369,5.58994884198605,5.32896733083848,5.52567894595321,5.49965557961031,5.41143613958310,5.40151981926474,5.29646825121844,5.20483348069555,5.71280133000831;5.58989428175769,5.62914583120727,5.60304883699379,5.60236068938973,5.57530279094260,5.58023859794562,5.87244849967078,5.52506859565977,5.68419130653094,5.65803140233963,5.46441262957118,5.55159355946845,5.57463552209612,5.56937434184248,5.52948064537802,5.44148882370790,5.57866599180678,5.58453060421177,5.55683519520903,5.55042103101253,5.64525442912249,5.75891541408783,5.45926849542810;5.54936332624042,5.60465353607511,5.60536558242980,5.49330710345123,5.47546954537476,5.51676791751402,5.89502398645471,5.59444375155899,5.52556801971950,5.59965428616917,5.54388673804199,5.54355796177064,5.68305016641269,5.48222520788700,5.68113104322036,5.77652472944270,5.61504515761669,5.42216099193072,5.62305654727629,5.69213390840008,5.61291663779364,5.39640436192160,5.70033250207814;5.60903389964085,5.67813042147158,5.59609860068576,5.32758841893684,5.69268913463226,5.48308959728501,5.32499294516038,5.40346719880269,5.56094443620263,5.38585757499943,5.56545828176978,5.48630432817381,5.51701655029151,5.56574312792767,5.58418996611861,5.50596743198139,5.58815620897458,5.42585121039166,5.50213060002304,5.62127746970630,5.70993001178020,5.69997052755674,5.37822111388196;5.53697886761014,5.62710480661292,5.55787230099157,5.55317966043707,5.49741091802703,5.61003095814821,5.06443420186248,5.49077076577700,5.41373289664380,5.43589510314554,5.49052555092588,5.50538887270609,5.49654665241355,5.52670757834344,5.52180214422145,5.49838171336098,5.48455467155940,5.56853965754773,5.57986870897156,5.52064078866297,5.61522648003141,5.61155319776009,5.54447215295096;5.39174294367323,5.60771507296663,5.66444259104810,5.71569088654151,5.33065648586976,5.51288195748760,5.60624588467689,5.56170491394363,5.46850928345639,5.55340747985231,5.70737633261050,5.53652681378507,5.56705407843762,5.69011220450997,5.50548532926373,5.66400323657328,5.54070512313557,5.61405235189923,5.47477830243004,5.72191415074964,5.55748042408704,5.52018862363690,5.52992518703242;5.76102498283064,5.63730992958465,5.73510332684645,5.56707864688021,5.65538880112340,5.65795779847411,6.18568337879786,5.58664879022200,5.49019160323637,5.68380831077854,5.56772897058323,5.63596733529536,5.70427820865649,5.52761538182214,5.54483764769117,5.84985334277334,5.54624108315012,5.39755953552450,5.56979154670045,5.55966317518998,5.67528237821357,5.70881226053640,5.46134663341646;5.57300638362549,5.56281253189101,5.74552868130850,5.57028610529017,5.49411971212919,5.55174155775184,5.62694008089550,5.50324270391619,5.47535633180796,5.52383984958416,5.44170574143667,5.54757576061955,5.60875201855938,5.58389919750173,5.65233666388321,5.65641751795287,5.46161998007054,5.53901790986027,5.62737533110676,5.55555555555555,5.64063474464694,5.62039493073976,5.66084788029925;5.62141835827113,5.47606898663129,5.41423408395885,5.54141897960057,5.65868000702124,5.56080879781350,5.12369485467031,5.35903591918184,5.61572082301521,5.30170355039007,5.48484882889225,5.57067810400072,5.44271840243819,5.51672174007771,5.52180214422145,5.51228886416507,5.55414959745662,5.64972446368825,5.75837844063112,5.54015198192647,5.50666389485598,5.28735632183908,5.44056525353283;5.49419619234190,5.52403306459843,5.31113891205634,5.55531796604371,5.55774969282078,5.61521223818344,5.35415294892296,5.51337615365428,5.49475630213742,5.59207284251067,5.59611258075137,5.71230551342447,5.45333242356010,5.63382838883039,5.51220401777573,5.28851016486295,5.52251554023061,5.65341468214918,5.53092249222619,5.52064078866297,5.71916938073130,5.66165635131152,5.25145469659185;5.85334549261999,5.51790999081539,5.43392642016495,5.73600478980456,5.57091451641215,5.59966839807775,5.86774527325746,5.64043402344724,5.51872097136793,5.63452892699828,5.57113500380341,5.58574484968410,5.74142728258315,5.61930353317114,5.68976935702151,5.50343885910792,5.52409724309191,5.44061208423539,5.52372451917540,5.54323269665229,5.38655209849167,5.56734453286177,5.68994181213633;5.65181657490909,5.51893050311256,5.55323881011954,5.57028610529017,5.50618746708794,5.63464203831557,5.84705107703885,5.64900848091793,5.67049720982780,5.68684088824194,5.65515048990111,5.57268700342517,5.75734831426600,5.57845237662951,5.56019465000432,5.56918175381815,5.67673156920741,5.54270812832120,5.41431532880341,5.69829533785171,5.75381701429792,5.62334217506631,5.64630091438072;5.41538600105831,5.52097152770691,5.46520248355111,5.61519052302955,5.56542917324908,5.57894327793682,5.20929357539272,5.54923297580444,5.53127389334581,5.40936005034079,5.59384189193792,5.56264250630292,5.41163448343834,5.60387087403319,5.52660120744431,5.48826742186710,5.56996662606963,5.57838024011022,5.48197627548083,5.44362292051756,5.73071859192017,5.47303271441202,5.63591022443890;5.51558752997602,5.57812021634861,5.35747382077657,5.45481760253176,5.46449885904862,5.55174155775184,5.19612454143543,5.53909952606635,5.56779148455420,5.45105799046255,5.46554797397791,5.48831322759826,5.36235509965808,5.47587058353608,5.31448261299394,5.42126024072014,5.54149597456622,5.63373351702421,5.48197627548083,5.26596837132881,5.54362137066038,5.65870910698497,5.57148794679967;5.56512536449713,5.37401775691397,5.51385413770735,5.55745627165035,5.51057574161840,5.43386743695030,5.64575298654877,5.52428909952607,5.54154446587317,5.63225449390073,5.53821001600836,5.44210854083590,5.52004912775491,5.52943098877955,5.50356570397459,5.52113886922221,5.54149597456622,5.51564652627436,5.52228492456525,5.69008009858287,5.49049499919156,5.64397288535220,5.59850374064838]  ;
        elseif inN==4
            OrdCurve =   [5.65905634989224,5.73441977625259,5.63964502941470,5.72844860971265,5.52786543584904,5.56868827492128,5.66886546869866,5.64335035029142,5.57656069539846,5.59488827972469,5.49845072101061,5.59758904388296,5.55504713096001,5.35312851255152,5.62576949169577;5.51902943847021,5.46518861478528,5.57782430950244,5.45503833940051,5.67925993649296,5.44909228512432,5.55639800844138,5.60466270258450,5.43675156525439,5.47951959295561,5.62060541055893,5.62556427308910,5.61682071931912,5.67159985013114,5.62828211764114;5.51902943847021,5.47640657984642,5.36045468142387,5.35125087135001,5.55932403338544,5.58550646098648,5.49447772133344,5.44823004011741,5.36988632909854,5.59587433687656,5.61017757120724,5.72347757531059,5.45895488240139,5.57559010865493,5.64335787331340;5.48292875036921,5.54881344524103,5.57283876757403,5.66183874215785,5.64780133895656,5.57803171162417,5.57029848105745,5.59288820110849,5.52428423804024,5.59390222257282,5.68317244666905,5.68660113681159,5.40404502608218,5.51704758336456,5.64335787331340;5.58138517246283,5.50088213997981,5.73736165121149,5.60529780807064,5.57701949449966,5.71724891849720,5.77627821164101,5.69213042783492,5.64828885782019,5.57911136529473,5.38374448814206,5.55562620007375,5.56419877367987,5.72780067440989,5.43229729390186;5.65468050891031,5.67017143090243,5.60275201914448,5.55030594067075,5.62715663432330,5.53038018443944,5.57661687770112,5.60298063094507,5.62883715275667,5.54854359358668,5.54910022643308,5.59377423990031,5.45666697172142,5.56153990258524,5.71119877383854;5.46323746595049,5.41623749451849,5.52796889021837,5.61071954147626,5.46986364664130,5.52944584076915,5.67518386534233,5.43056828790338,5.70421250987782,5.47656142149999,5.62060541055893,5.69423074477690,5.51386473872060,5.78868490071188,5.52526445388075;5.57482141098992,5.56513048532996,5.35247781433842,5.59290527457207,5.47084672781432,5.48272865725471,5.56524376374251,5.39692685511476,5.65558324721901,5.43613307827322,5.64444047193422,5.45516969519716,5.56877459503981,5.62710753091045,5.42475941606573;5.55184824583475,5.53555585016878,5.61372021138698,5.69049647587329,5.58685030622979,5.57896605529446,5.58293527434478,5.48355354454546,5.63856300528843,5.61855365136963,5.63550232391848,5.46534250581758,5.68774595039810,5.43742974896965,5.66345888087640;5.59998249663607,5.59164567547447,5.60275201914448,5.58980714119743,5.76675416089107,5.66959739131247,5.44519422751283,5.55756469668043,5.63248434745608,5.68264736624135,5.70849719938029,5.56325580803906,5.52530429212043,5.34610340951667,5.67853463654866;5.63936506547352,5.59980419551893,5.43124937680726,5.57896367438618,5.39711563983838,5.56027918188868,5.49068668334723,5.51635394151437,5.56805057443317,5.59390222257282,5.63252294124657,5.68024313017383,5.50471309600073,5.63647433495691,5.42475941606573;5.50918379626084,5.57634845039110,5.55987635856017,5.50615754008210,5.43447272441286,5.43694581741056,5.34409988121414,5.40197307003305,5.49024375417908,5.40556530656517,5.63252294124657,5.39158962881957,5.59851743387938,5.50299737729487,5.42475941606573;5.54966032534378,5.53045677514099,5.54093129923223,5.38223220509643,5.41186185743357,5.51823371672569,5.43382111355422,5.64082724283227,5.33098291897149,5.56432050801664,5.52973423906567,5.47297211378289,5.86391507275556,5.48894717122518,5.51521395009925;5.57263349049895,5.50700103001316,5.73137900089740,5.48679420649059,5.63600436488041,5.62568323880890,5.55639800844138,5.57438541307474,5.44526168621968,5.43909124972883,5.43737337623644,5.42846606731857,5.66029102223849,5.50065567628325,5.46747405713711;5.57810329172638,5.50292176999092,5.62867683717220,5.65641700875223,5.48559294540950,5.59111252300821,5.49700507999090,5.66774038906317,5.64221019998784,5.49233833592995,5.56697652246454,5.47933012042065,5.65342729019859,5.83317721993256,5.39209527877585;5.47089518766888,5.57736826539666,5.50104696380496,5.62930834172411,5.64288593309150,5.55841049454811,5.55134329112644,5.58868302200991,5.57412923226552,5.62841422288836,5.43588368490049,5.46407090449003,5.31939233092340,5.49363057324841,5.46998668308249;5.38009648729365,5.61408160559675,5.48010768770565,5.45658740608783,5.50525456886975,5.43227409905912,5.56145272575631,5.61307306078166,5.72731140964075,5.64912142307768,5.35097127875104,5.55562620007375,5.57563832707971,5.69970026227051,5.56546646900676;5.69406307774775,5.58756641545224,5.53893708246086,5.46743087289908,5.57407025098063,5.58737514832706,5.65370131675386,5.54410812356498,5.40635827609264,5.62151182282525,5.45971874627577,5.56707061202172,5.47268234648119,5.23838516298239,5.76396391869142] ;
        end
    end
    %%%%%%%%%%%%%%%%%%%%%

    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  model fitting  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    if modej==0 || modej==1
        
        Uyy= [];w=[];Usta =double([]);
        para2p = [];para1p = [];  para = [];
        for i = 1:size(OrdCurve,2)  %%% case number
            
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%% combined model fitnlm %%%%%%%%%%%%
            meandata = OrdCurve(:,i);
            amp1 = mean(meandata([1 2 9 10 11])) - mean(meandata([4 5 14 15]));
            amp2 = max(meandata(4:16))-min(meandata(4:16));
            radialloc = (RaOri(i)-0)/10+1;
            yfit0 = min(meandata);
            warning('off')    
            opts = statset('FunValCheck','off','MaxIter',10000,'TolFun',1e-10);
            xfit = [0:20:360-20];
            yfit = meandata';
            func0 = [amp1/(60./180*pi);60./180*pi;amp2/(60./180*pi);120./180*pi;yfit0] ;  %%%%%amplitude  half-width   prefer-ori  baseline
            fun = @(beta,x) abs(beta(1)).*exp(abs(beta(2)).*cos(x./180*pi))+abs(beta(1)).*exp(abs(beta(2)).*cos((x-180)./180*pi))+abs(beta(3)).*exp(abs(beta(4)).*cos((x-(RaOri(i)-0)*2)./180*pi))+abs(beta(5));
            Umodel = fitnlm(xfit,yfit,fun,func0,'Options',opts);
            beta = table2array(Umodel.Coefficients(:,1));
            xx =[0:360-1]; %
            yy =abs(beta(1)).*exp(abs(beta(2)).*cos(xx./180*pi))+abs(beta(1)).*exp(abs(beta(2)).*cos((xx-180)./180*pi))+abs(beta(3)).*exp(abs(beta(4)).*cos((xx-(RaOri(i)-0)*2)./180*pi))+abs(beta(5));
            yy1 =abs(beta(1)).*exp(abs(beta(2)).*cos(xx./180*pi))+abs(beta(1)).*exp(abs(beta(2)).*cos((xx-180)./180*pi));
            yy1 = yy1-min(yy1(:));
            w(i,1) = (max(yy1)-min(yy1));
            yy2 =abs(beta(3)).*exp(abs(beta(4)).*cos((xx-(RaOri(i)-0)*2)./180*pi));
            yy2 = yy2-min(yy2(:));
            w(i,2) = (max(yy2)-min(yy2));
            temppeak = find(abs(yy2)==max(abs(yy2)));
            yyn = find((abs(temppeak)-(RaOri(i)-0)*2)==min((abs(temppeak)-(RaOri(i)-0)*2)));
            peak(i,1) = temppeak(yyn(1));
            para(i,[1 2]) = w(i,[1 2]);                     %%% Ac and Ar
            para(i,3) = mean(yy-yy1-yy2);                   %%% A0
            para(i,4) = peak(i,1) ;                         %%% radial orientation
            para(i,5) = Umodel.Rsquared.Adjusted ;          %%% adjusted R2
            para(i,6) = Umodel.LogLikelihood ;              %%% LogLikelihood
            para(i,7) = Umodel.DFE ;                        %%% df
            para(i,8) = Umodel.ModelCriterion.AIC ;         %%% AIC
            para(i,9) = Umodel.ModelCriterion.AICc ;        %%% AICc
            para(i,10) = Umodel.ModelCriterion.BIC ;        %%% BIC
            Uyy(:,i,1) = yy;                                %%% fitted curve
            Uyy(:,i,2) = yy1;                               %%% cardinal component
            Uyy(:,i,3) = yy2;                               %%% radial component
            %%%%%%% plot fitted curves for checking %%%%%%%%%%%%
            fig = figure;
            set(fig,'visible','off');
            plot(yy,'linewidth',2,'color',[0 0 0]); hold on;
            plot([xfit,360],[yfit,yfit(1)],'linewidth',2,'color',[0.55 0.55 0.55]);
            plot(yy1,'linewidth',2,'color',[1 0 0]); 
            plot(yy2,'linewidth',2,'color',[0 0 1]); 
            xlim([0 360]);
            saveas(fig,[Resultfolder,tempname,'_case',num2str(i,'%03d'),'_combined_model_fitnlm_shuffle.tiff']);

            
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%% cardinal model(2p) fitnlm %%%%%%%%%%%%
            func0 = [amp1/(60./180*pi);60./180*pi;yfit0] ;  %%%%%amplitude  half-width   prefer-ori  baseline
            fun = @(beta,x) abs(beta(1)).*exp(abs(beta(2)).*cos(x./180*pi))+abs(beta(1)).*exp(abs(beta(2)).*cos((x-180)./180*pi))+abs(beta(3));
            Umodel2p = fitnlm(xfit,yfit,fun,func0,'Options',opts);
            beta2p = table2array(Umodel2p.Coefficients(:,1));
            yy2p =abs(beta2p(1)).*exp(abs(beta2p(2)).*cos(xx./180*pi))+abs(beta2p(1)).*exp(abs(beta2p(2)).*cos((xx-180)./180*pi)); 
            yy2p = yy2p-min(yy2p(:));
            para2p(i,[1]) = max(yy2p(:))-min(yy2p(:));                      %%% Ac
            para2p(i,3) = abs(beta2p(3))+min(yy2p(:));                      %%% A0
            para2p(i,5) = Umodel2p.Rsquared.Adjusted ;                      %%% adjusted R2
            para2p(i,6) = Umodel2p.LogLikelihood ;                          %%% LogLikelihood
            para2p(i,7) = Umodel2p.DFE ;                                    %%% df
            para2p(i,8) = Umodel2p.ModelCriterion.AIC ;                     %%% AIC
            para2p(i,9) = Umodel2p.ModelCriterion.AICc ;                    %%% AICc
            para2p(i,10) = Umodel2p.ModelCriterion.BIC ;                    %%% BIC
            
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%% radial model(1p) fitnlm %%%%%%%%%%%%
            func0 = [amp2/(60./180*pi);120./180*pi;yfit0] ;  %%%%%amplitude  half-width   prefer-ori  baseline
            fun = @(beta,x) abs(beta(1)).*exp(abs(beta(2)).*cos((x-(RaOri(i)-0)*2)./180*pi))+abs(beta(3));
            Umodel1p = fitnlm(xfit,yfit,fun,func0,'Options',opts);
            beta1p = table2array(Umodel1p.Coefficients(:,1));
            yy1p =abs(beta1p(1)).*exp(abs(beta1p(2)).*cos((xx-(RaOri(i)-0)*2)./180*pi));
            yy1p = yy1p-min(yy1p(:));
            temppeak = find(yy1p==max(yy1p(:)));
            yyn = find((abs(temppeak)-(RaOri(i)-0)*2)==min((abs(temppeak)-(RaOri(i)-0)*2)));
            para1p(i,[2]) = max(yy1p(:))-min(yy1p(:));                      %%% Ar
            para1p(i,3) = abs(beta1p(3))+min(yy1p(:));                      %%% A0
            para1p(i,4) =  temppeak(yyn);                                   %%% radial orientation
            para1p(i,5) = Umodel1p.Rsquared.Adjusted ;                      %%% adjusted R2
            para1p(i,6) = Umodel1p.LogLikelihood ;                          %%% LogLikelihood
            para1p(i,7) = Umodel1p.DFE ;                                    %%% df
            para1p(i,8) = Umodel1p.ModelCriterion.AIC ;                     %%% AIC
            para1p(i,9) = Umodel1p.ModelCriterion.AICc ;                    %%% AICc
            para1p(i,10) = Umodel1p.ModelCriterion.BIC ;                    %%% BIC
            
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%% likelihood ratio test %%%%%%%%%%%%
            [h31(i),p31(i),n31(i),m31(i)] = lratiotest(para(i,6),para1p(i,6),2);    %%% LRT combined vs. radial model
            [h32(i),p32(i),n32(i),m32(i)] = lratiotest(para(i,6),para2p(i,6),2);    %%% LRT combined vs. cardinal model
            Usta(i,1)  = h31(i);Usta(i,2)  = p31(i); Usta(i,3)  = n31(i);Usta(i,4)  = m31(i);
            Usta(i,5)  = h32(i);Usta(i,6)  = p32(i); Usta(i,7)  = n32(i);Usta(i,8)  = m32(i);

        end
        
        %%%%%%% save data in *.mat
        save([Resultfolder,tempname,'_parameters_3peak_fitnlm_shuffle.mat'],'para','-v7.3');
        save([Resultfolder,tempname,'_parameters_1peak_fitnlm_shuffle.mat'],'para1p','-v7.3');
        save([Resultfolder,tempname,'_parameters_2peak_fitnlm_shuffle.mat'],'para2p','-v7.3');
        save([Resultfolder,tempname,'_statc_lratiotest_shuffle.mat'],'Usta','-v7.3');
        save([Resultfolder,tempname,'_yyCombined_yyCardinal_yyRadial_fitnlm_shuffle.mat'],'Uyy','-v7.3');

        %%%%%%% plot curves for checking %%%%%%%%%%%%
        for plotyy = 1

            fig = figure;hold on ;
            set(fig,'visible','off');
            set(gca,'box','off');
            plot(repmat([0:20:360]',1,size(OrdCurve,2)),[OrdCurve(:,:);OrdCurve(1,:)],'linewidth',0.5,'color',[0.55 0.55 0.55])
            errorbar(repmat([0:20:360]',1,1),mean([OrdCurve(:,:);OrdCurve(1,:)]'),std([OrdCurve(:,:);OrdCurve(1,:)]')/sqrt(size(OrdCurve,2)),'linewidth',2,'color',[0.0 0.0 0.0])
            xlim([0 360]);
            set(gca,'XTick',[0:60:360],'Xticklabel',{'0','30','60','90','120','150','180'},'fontsize',15);
            saveas(fig,[Resultfolder,'',tempname,'plot_1_Original_model_shuffle.tiff']);

            nN = size(Uyy,2);
            for cN = 1:size(Uyy,1)
                meanV(cN,1) = mean(Uyy(cN,:,1));
                stdV = std(Uyy(cN,:,1));
                UyyComup(cN,1) = meanV(cN,1)+1.96*stdV/(sqrt(nN));
                UyyComdown(cN,1) = meanV(cN,1)-1.96*stdV/(sqrt(nN));
            end
            fig = figure;hold on ;
            set(gca,'box','off');
            set(fig,'visible','off');
            plot(Uyy(:,:,1),'linewidth',0.5,'color',[0.55 0.55 0.55]);
            xlim([0 360]);
            h = fill([1:1:360,fliplr(1:1:360)],[UyyComup;flipud(UyyComdown)]',[0.55 0.55 0.55]); %%% fill x 最小→最大→最小  y max值（最小→最大） min值（最大→最小）
            set(h,'edgealpha',0,'facealpha',0.5) ;
            plot(meanV,'linewidth',2,'color',[0.0 0.0 0.0])
            set(gca,'XTick',[0:60:360],'Xticklabel',{'0','30','60','90','120','150','180'},'fontsize',15);
            saveas(fig,[Resultfolder,'',tempname,'plot_2_Combined_model_shuffle.tiff']);

            fig = figure;hold on ;
            set(fig,'visible','off');
            set(gca,'box','off');
            plot(Uyy(:,:,2),'linewidth',0.5,'color',[0 0 0])
            xlim([0 360]);
            set(gca,'XTick',[0:60:360],'Xticklabel',{'0','30','60','90','120','150','180'},'fontsize',15);
            saveas(fig,[Resultfolder,'',tempname,'plot_3_cardinal_component_model_shuffle.tiff']);

            fig = figure;hold on ;
            set(fig,'visible','off');
            set(gca,'box','off');
            plot(Uyy(:,:,3),'linewidth',0.5,'color',[0 0 0])
            xlim([0 360]);
            set(gca,'XTick',[0:60:360],'Xticklabel',{'0','30','60','90','120','150','180'},'fontsize',15);
            saveas(fig,[Resultfolder,'',tempname,'plot_4_radial_component_model_shuffle.tiff']);
            
        end
        %%%%%%%%%%%%%%%%%%
        
    end
        
end













